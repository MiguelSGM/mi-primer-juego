<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Snake Neon - Fixed Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        /* Ajuste para que todo quepa y sea interactivo */
        body { 
            margin: 0; 
            background: #0a0a0a; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; /* Evita el scroll que oculta parte del juego */
        }

        #ui-panel {
            width: 640px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #151515;
            border: 2px solid #33ff00;
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            box-sizing: border-box;
        }

        .difficulty-controls button {
            background: #222;
            border: 1px solid #33ff00;
            color: #33ff00;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Courier New';
        }

        .difficulty-controls button.active {
            background: #33ff00;
            color: #000;
        }

        .stat-box { text-align: right; }
        .label { font-size: 10px; color: #888; display: block; }
        .value { font-size: 18px; font-weight: bold; }

        /* Estilo del lienzo para asegurar que se vea y reciba clics */
        canvas { 
            border: 2px solid #33ff00; 
            border-radius: 0 0 10px 10px;
            display: block;
            touch-action: none; /* Mejora la interacción en móviles/tablets */
        }
    </style>
</head>
<body onclick="document.querySelector('canvas').focus()">

    <div id="ui-panel">
        <div class="difficulty-controls">
            <button id="btn-200" onclick="setDifficulty(200)">FÁCIL</button>
            <button id="btn-120" onclick="setDifficulty(120)">MEDIO</button>
            <button id="btn-70" onclick="setDifficulty(70)">DIFÍCIL</button>
        </div>
        <div class="stat-box">
            <span class="label">MANZANAS | RÉCORD</span>
            <span id="score-display">0 | 0</span>
        </div>
    </div>

<script>
    // Configuración de velocidad persistente
    let gameSpeed = parseInt(localStorage.getItem('snakeSpeed')) || 120;

    const config = {
        type: Phaser.AUTO,
        width: 640,
        height: 480,
        backgroundColor: '#050505',
        // Esto asegura que el teclado funcione incluso si haces clic fuera
        input: { windowEvents: true },
        scene: { preload: preload, create: create, update: update }
    };

    let snake = [];
    let food, cursors, moveTime = 0;
    let direction = { x: 16, y: 0 };
    let nextDirection = { x: 16, y: 0 };
    let appleCount = 0;
    let highScore = localStorage.getItem('snakeHighScore') || 0;
    let audioCtx, particles;

    const game = new Phaser.Game(config);

    function preload() {
        let graphics = this.make.graphics({ x: 0, y: 0, add: false });
        graphics.lineStyle(2, 0x00ff00, 1);
        graphics.fillStyle(0x004400, 1);
        graphics.fillRoundedRect(1, 1, 14, 14, 4);
        graphics.strokeRoundedRect(1, 1, 14, 14, 4);
        graphics.generateTexture('block', 16, 16);

        graphics.clear();
        graphics.fillStyle(0xff0000, 1);
        graphics.fillCircle(8, 8, 7);
        graphics.generateTexture('food', 16, 16);

        graphics.clear();
        graphics.fillStyle(0xff0000, 1);
        graphics.fillRect(0, 0, 4, 4);
        graphics.generateTexture('flare', 4, 4);
    }

    function create() {
        updateUI();
        highlightButton();

        // Dibujo de rejilla
        let grid = this.add.graphics();
        grid.lineStyle(1, 0x111111, 1);
        for (let i = 0; i < 640; i += 16) { grid.moveTo(i, 0); grid.lineTo(i, 480); }
        for (let j = 0; j < 480; j += 16) { grid.moveTo(0, j); grid.lineTo(640, j); }
        grid.strokePath();

        particles = this.add.particles(0, 0, 'flare', {
            speed: { min: 50, max: 150 }, scale: { start: 1, end: 0 },
            lifespan: 400, emitting: false
        });

        // Reiniciar variables de estado
        snake = [];
        for (let i = 0; i < 3; i++) {
            snake.push(this.add.image(160 - (i * 16), 160, 'block'));
        }

        food = this.add.image(320, 240, 'food');
        cursors = this.input.keyboard.createCursorKeys();

        // Forzar foco al iniciar
        this.input.on('pointerdown', () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        });
    }

    function update(time) {
        // Captura de entrada mejorada
        if (cursors.left.isDown && direction.x === 0) nextDirection = { x: -16, y: 0 };
        else if (cursors.right.isDown && direction.x === 0) nextDirection = { x: 16, y: 0 };
        else if (cursors.up.isDown && direction.y === 0) nextDirection = { x: 0, y: -16 };
        else if (cursors.down.isDown && direction.y === 0) nextDirection = { x: 0, y: 16 };

        if (time >= moveTime) {
            moveTime = time + gameSpeed; 
            moveSnake();
        }
    }

    function moveSnake() {
        direction = nextDirection;
        let x = snake[0].x + direction.x;
        let y = snake[0].y + direction.y;

        if (x === food.x && y === food.y) {
            particles.emitParticleAt(food.x, food.y, 10);
            playEatSound();
            appleCount++;
            if (appleCount > highScore) {
                highScore = appleCount;
                localStorage.setItem('snakeHighScore', highScore);
            }
            updateUI();
            let newPart = game.scene.scenes[0].add.image(food.x, food.y, 'block');
            snake.unshift(newPart);
            repositionFood();
        } else {
            let part = snake.pop();
            part.x = x; part.y = y;
            snake.unshift(part);
        }

        // Colisiones
        if (x < 0 || x >= 640 || y < 0 || y >= 480) gameOver();
        for (let i = 1; i < snake.length; i++) {
            if (x === snake[i].x && y === snake[i].y) gameOver();
        }
    }

    function repositionFood() {
        let x = Math.floor(Math.random() * (640 / 16)) * 16;
        let y = Math.floor(Math.random() * (480 / 16)) * 16;
        food.setPosition(x, y);
    }

    function playEatSound() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function updateUI() {
        document.getElementById('score-display').innerText = appleCount + " | " + highScore;
    }

    function highlightButton() {
        document.querySelectorAll('.difficulty-controls button').forEach(b => b.classList.remove('active'));
        const activeBtn = document.getElementById('btn-' + gameSpeed);
        if (activeBtn) activeBtn.classList.add('active');
    }

    window.setDifficulty = function(speed) {
        localStorage.setItem('snakeSpeed', speed);
        location.reload();
    }

    function gameOver() {
        alert("GAME OVER\nManzanas: " + appleCount);
        location.reload();
    }
</script>
</body>
</html>
